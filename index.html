<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Stock ASBL</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-4">
    <div id="app" class="max-w-7xl mx-auto"></div>

    <script>
        let state = {
            events: [{
                id: 1,
                name: 'Marche ADEPS Fanchons 2025',
                date: '2025-03-15',
                items: [
                    {id: 1, article: 'Jupiler', format: '25 cl', fournisseur: 'Colruyt', responsable: 'Nathan Luc', stockSalle: 0, qteAchetee: 360, prixAchat: 0.38, qteRemise: 72, qteConsomme: 288, prixVente: 0.38, payePar: 'Caisse Fanchons', categorie: 'Boissons'},
                    {id: 2, article: 'Coca-cola Zero', format: '1,5 litre', fournisseur: 'Colruyt', responsable: 'Nathan Luc', stockSalle: 0, qteAchetee: 16, prixAchat: 2.08, qteRemise: 6, qteConsomme: 10, prixVente: 2.08, payePar: 'Caisse Fanchons', categorie: 'Boissons'},
                    {id: 3, article: 'Saucisses', format: '', fournisseur: 'Courses', responsable: 'Julien', stockSalle: 0, qteAchetee: 120, prixAchat: 1.35, qteRemise: 0, qteConsomme: 120, prixVente: 1.35, payePar: 'Caisse Fanchons', categorie: 'Nourriture'}
                ]
            }],
            activeEvent: 0,
            newItem: {article: '', format: '', fournisseur: '', responsable: '', stockSalle: 0, qteAchetee: 0, prixAchat: 0, qteRemise: 0, qteConsomme: 0, prixVente: 0, payePar: 'Caisse Fanchons', categorie: 'Boissons'}
        };

        const categories = ['Boissons', 'Nourriture', 'Autre'];

        function calculateItemStats(item) {
            const totalAchat = item.qteAchetee * item.prixAchat;
            const totalVente = item.qteConsomme * item.prixVente;
            const marge = totalVente - totalAchat;
            const stockRestant = item.qteAchetee - item.qteConsomme - item.qteRemise;
            return { totalAchat, totalVente, marge, stockRestant };
        }

        function calculateEventTotals() {
            const currentEvent = state.events[state.activeEvent];
            let totalAchat = 0, totalVente = 0;
            currentEvent.items.forEach(item => {
                const stats = calculateItemStats(item);
                totalAchat += stats.totalAchat;
                totalVente += stats.totalVente;
            });
            return {
                totalAchat: totalAchat.toFixed(2),
                totalVente: totalVente.toFixed(2),
                marge: (totalVente - totalAchat).toFixed(2),
                margePercent: totalAchat > 0 ? (((totalVente - totalAchat) / totalAchat) * 100).toFixed(1) : 0
            };
        }

        function getStockByCategory() {
            const currentEvent = state.events[state.activeEvent];
            const stockByCategory = {};
            categories.forEach(cat => {
                stockByCategory[cat] = currentEvent.items.filter(item => item.categorie === cat).map(item => ({...item, ...calculateItemStats(item)}));
            });
            return stockByCategory;
        }

        function addEvent() {
            state.events.push({id: Date.now(), name: `Nouvel √âv√©nement ${state.events.length + 1}`, date: new Date().toISOString().split('T')[0], items: []});
            state.activeEvent = state.events.length - 1;
            render();
        }

        function setActiveEvent(index) {
            state.activeEvent = index;
            render();
        }

        function addItem() {
            if (state.newItem.article) {
                state.events[state.activeEvent].items.push({...state.newItem, id: Date.now()});
                state.newItem = {article: '', format: '', fournisseur: '', responsable: '', stockSalle: 0, qteAchetee: 0, prixAchat: 0, qteRemise: 0, qteConsomme: 0, prixVente: 0, payePar: 'Caisse Fanchons', categorie: 'Boissons'};
                render();
            }
        }

        function deleteItem(itemId) {
            state.events[state.activeEvent].items = state.events[state.activeEvent].items.filter(item => item.id !== itemId);
            render();
        }

        function updateItem(itemId, field, value) {
            const item = state.events[state.activeEvent].items.find(i => i.id === itemId);
            if (item) {
                item[field] = (field.includes('qte') || field.includes('prix') || field === 'stockSalle') ? parseFloat(value) || 0 : value;
                render();
            }
        }

        function updateNewItem(field, value) {
            state.newItem[field] = (field.includes('qte') || field.includes('prix') || field === 'stockSalle') ? parseFloat(value) || 0 : value;
        }

        function exportToCSV() {
            const currentEvent = state.events[state.activeEvent];
            let csv = 'Article,Format,Fournisseur,Qt√© Achet√©e,Prix Achat,Total Achat,Qt√© Vendue,Prix Vente,Total Vente,Marge,Stock Restant,Cat√©gorie\n';
            currentEvent.items.forEach(item => {
                const stats = calculateItemStats(item);
                csv += `"${item.article}","${item.format}","${item.fournisseur}",${item.qteAchetee},${item.prixAchat},${stats.totalAchat.toFixed(2)},${item.qteConsomme},${item.prixVente},${stats.totalVente.toFixed(2)},${stats.marge.toFixed(2)},${stats.stockRestant},"${item.categorie}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentEvent.name.replace(/\s+/g, '_')}.csv`;
            a.click();
        }

        function render() {
            const currentEvent = state.events[state.activeEvent];
            const totals = calculateEventTotals();
            const stockByCategory = getStockByCategory();

            document.getElementById('app').innerHTML = `
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <div class="flex items-center justify-between mb-4 flex-wrap gap-4">
                        <h1 class="text-3xl font-bold text-gray-800">üì¶ Gestion de Stock ASBL</h1>
                        <button onclick="addEvent()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">+ Nouvel √âv√©nement</button>
                    </div>
                    <div class="flex gap-2 overflow-x-auto pb-2">
                        ${state.events.map((event, index) => `
                            <button onclick="setActiveEvent(${index})" class="px-4 py-2 rounded-lg whitespace-nowrap ${state.activeEvent === index ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-700'}">${event.name}</button>
                        `).join('')}
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white rounded-lg shadow p-4"><p class="text-gray-500 text-sm">Total Achats</p><p class="text-2xl font-bold text-red-600">${totals.totalAchat}‚Ç¨</p></div>
                    <div class="bg-white rounded-lg shadow p-4"><p class="text-gray-500 text-sm">Total Ventes</p><p class="text-2xl font-bold text-green-600">${totals.totalVente}‚Ç¨</p></div>
                    <div class="bg-white rounded-lg shadow p-4"><p class="text-gray-500 text-sm">Marge</p><p class="text-2xl font-bold text-indigo-600">${totals.marge}‚Ç¨</p></div>
                    <div class="bg-white rounded-lg shadow p-4"><p class="text-gray-500 text-sm">Rentabilit√©</p><p class="text-2xl font-bold text-purple-600">${totals.margePercent}%</p></div>
                </div>

                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">üìä Stock Restant par Cat√©gorie</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        ${categories.map(categorie => {
                            const items = stockByCategory[categorie] || [];
                            const totalStock = items.reduce((sum, item) => sum + item.stockRestant, 0);
                            return `
                                <div class="border rounded-lg p-4">
                                    <h3 class="font-bold text-lg mb-3 text-gray-700 border-b pb-2">${categorie}</h3>
                                    ${items.length === 0 ? '<p class="text-gray-400 text-sm italic">Aucun article</p>' : `
                                        <div class="space-y-2">
                                            ${items.map(item => `
                                                <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                                    <div class="flex-1"><p class="font-semibold text-sm">${item.article}</p><p class="text-xs text-gray-500">Achet√©: ${item.qteAchetee} ‚Ä¢ Vendu: ${item.qteConsomme}</p></div>
                                                    <span class="font-bold text-lg ${item.stockRestant > 0 ? 'text-orange-600' : 'text-green-600'}">${item.stockRestant}</span>
                                                </div>
                                            `).join('')}
                                            <div class="pt-2 border-t flex justify-between"><span class="font-bold">Total:</span><span class="font-bold text-xl ${totalStock > 0 ? 'text-orange-600' : 'text-green-600'}">${totalStock}</span></div>
                                        </div>
                                    `}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-lg overflow-hidden mb-6">
                    <div class="p-4 bg-indigo-600 text-white flex justify-between items-center">
                        <h2 class="text-xl font-bold">Articles - ${currentEvent.name}</h2>
                        <button onclick="exportToCSV()" class="bg-white text-indigo-600 px-4 py-2 rounded-lg hover:bg-indigo-50">üì• Exporter CSV</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-3 py-2 text-left">Article</th>
                                    <th class="px-3 py-2 text-left">Format</th>
                                    <th class="px-3 py-2 text-left">Cat√©gorie</th>
                                    <th class="px-3 py-2 text-left">Fournisseur</th>
                                    <th class="px-3 py-2 text-left">Qt√© Achet√©e</th>
                                    <th class="px-3 py-2 text-left">Prix Achat</th>
                                    <th class="px-3 py-2 text-left">Total Achat</th>
                                    <th class="px-3 py-2 text-left">Qt√© Vendue</th>
                                    <th class="px-3 py-2 text-left">Prix Vente</th>
                                    <th class="px-3 py-2 text-left">Total Vente</th>
                                    <th class="px-3 py-2 text-left">Marge</th>
                                    <th class="px-3 py-2 text-left">Stock</th>
                                    <th class="px-3 py-2 text-left">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${currentEvent.items.map(item => {
                                    const stats = calculateItemStats(item);
                                    return `
                                        <tr class="border-b hover:bg-gray-50">
                                            <td class="px-3 py-2"><input type="text" value="${item.article}" onchange="updateItem(${item.id}, 'article', this.value)" class="w-full border rounded px-2 py-1"></td>
                                            <td class="px-3 py-2"><input type="text" value="${item.format}" onchange="updateItem(${item.id}, 'format', this.value)" class="w-20 border rounded px-2 py-1"></td>
                                            <td class="px-3 py-2">
                                                <select onchange="updateItem(${item.id}, 'categorie', this.value)" class="w-full border rounded px-2 py-1">
                                                    ${categories.map(cat => `<option value="${cat}" ${item.categorie === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                                                </select>
                                            </td>
                                            <td class="px-3 py-2"><input type="text" value="${item.fournisseur}" onchange="updateItem(${item.id}, 'fournisseur', this.value)" class="w-24 border rounded px-2 py-1"></td>
                                            <td class="px-3 py-2"><input type="number" value="${item.qteAchetee}" onchange="updateItem(${item.id}, 'qteAchetee', this.value)" class="w-20 border rounded px-2 py-1"></td>
                                            <td class="px-3 py-2"><input type="number" step="0.01" value="${item.prixAchat}" onchange="updateItem(${item.id}, 'prixAchat', this.value)" class="w-20 border rounded px-2 py-1"></td>
                                            <td class="px-3 py-2 font-semibold text-red-600">${stats.totalAchat.toFixed(2)}‚Ç¨</td>
                                            <td class="px-3 py-2"><input type="number" value="${item.qteConsomme}" onchange="updateItem(${item.id}, 'qteConsomme', this.value)" class="w-20 border rounded px-2 py-1"></td>
                                            <td class="px-3 py-2"><input type="number" step="0.01" value="${item.prixVente}" onchange="updateItem(${item.id}, 'prixVente', this.value)" class="w-20 border rounded px-2 py-1"></td>
                                            <td class="px-3 py-2 font-semibold text-green-600">${stats.totalVente.toFixed(2)}‚Ç¨</td>
                                            <td class="px-3 py-2 font-bold ${stats.marge >= 0 ? 'text-green-600' : 'text-red-600'}">${stats.marge.toFixed(2)}‚Ç¨</td>
                                            <td class="px-3 py-2 font-semibold ${stats.stockRestant > 0 ? 'text-orange-600' : 'text-gray-600'}">${stats.stockRestant}</td>
                                            <td class="px-3 py-2"><button onclick="deleteItem(${item.id})" class="text-red-600 hover:text-red-800 text-xl">üóëÔ∏è</button></td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">‚ûï Ajouter un nouvel article</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <input type="text" placeholder="Article" oninput="updateNewItem('article', this.value)" class="border rounded px-3 py-2">
                        <input type="text" placeholder="Format" oninput="updateNewItem('format', this.value)" class="border rounded px-3 py-2">
                        <select onchange="updateNewItem('categorie', this.value)" class="border rounded px-3 py-2">
                            ${categories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                        </select>
                        <input type="text" placeholder="Fournisseur" oninput="updateNewItem('fournisseur', this.value)" class="border rounded px-3 py-2">
                        <input type="number" placeholder="Qt√© Achet√©e" oninput="updateNewItem('qteAchetee', this.value)" class="border rounded px-3 py-2">
                        <input type="number" step="0.01" placeholder="Prix Achat" oninput="updateNewItem('prixAchat', this.value)" class="border rounded px-3 py-2">
                        <input type="number" step="0.01" placeholder="Prix Vente" oninput="updateNewItem('prixVente', this.value)" class="border rounded px-3 py-2">
                        <button onclick="addItem()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">‚ûï Ajouter</button>
                    </div>
                </div>
            `;
        }

        render();
    </script>
</body>
</html>
